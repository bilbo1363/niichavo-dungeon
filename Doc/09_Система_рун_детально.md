# Система рун - Детальная спецификация

## 1. Обзор системы

Руны - ключевой элемент геймплея, влияющий на:
- Характеристики персонажа
- Исследование уровней
- Прогрессию игры
- Доступ к финальному тайнику

---

## 2. Типы рун

### 2.1 Руны эффективности

#### Описание
Руны, изменяющие характеристики игрока. **Всегда** имеют как положительный, так и отрицательный эффект.

#### Механика
```python
@dataclass
class EfficiencyRune:
    name: str
    positive_effect: dict  # {"stat": "health", "value": +20}
    negative_effect: dict  # {"stat": "endurance", "value": -10}
    slot: Optional[str] = None  # "bracer" или "belt"
    
    def is_active(self) -> bool:
        """Руна активна только если экипирована"""
        return self.slot is not None
```

#### Слоты экипировки
- **Нарукавники (Bracers):** 2 слота
- **Пояс (Belt):** 3 слота
- **Всего:** 5 активных рун одновременно

#### Примеры рун эффективности

| Название | Положительный эффект | Отрицательный эффект |
|----------|---------------------|---------------------|
| Руна Берсерка | +30% урон | -20% защита |
| Руна Выносливости | +50 макс. выносливость | -10% скорость |
| Руна Ясности | +30 ясность ума | -15% макс. здоровье |
| Руна Регенерации | +2 HP/сек | -20% макс. выносливость |
| Руна Скорости | +30% скорость | -10 макс. здоровье |
| Руна Защиты | +40% защита | -20% урон |
| Руна Удачи | +15% шанс крит. удара | -10% точность |
| Руна Голода | Еда восстанавливает x2 | Голод наступает x1.5 быстрее |

#### Комбинирование
```python
class RuneCombination:
    """Система комбинирования рун"""
    
    SYNERGIES = {
        ("Берсерк", "Регенерация"): {
            "bonus": "Кровожадность",
            "effect": "Восстановление здоровья при убийстве"
        },
        ("Выносливость", "Скорость"): {
            "bonus": "Марафонец",
            "effect": "Бег не тратит выносливость"
        },
        ("Ясность", "Удача"): {
            "bonus": "Озарение",
            "effect": "Шанс бесплатного каста заклинания"
        }
    }
    
    @staticmethod
    def check_synergy(rune1: str, rune2: str) -> Optional[dict]:
        """Проверка синергии между рунами"""
        key = tuple(sorted([rune1, rune2]))
        return RuneCombination.SYNERGIES.get(key)
```

#### Хранение и смерть
- ✅ **Сохраняются в рюкзаке** после смерти
- ✅ **Не исчезают** при смерти персонажа
- ❌ **Не активны** в рюкзаке
- ✅ **Можно переэкипировать** в любой момент

---

### 2.2 Руна карта-ключ

#### Описание
Специальная руна для обнаружения тайных комнат и проходов.

#### Механика
```python
@dataclass
class MapKeyRune:
    name: str = "Руна карта-ключ"
    detection_radius: int = 10  # Радиус обнаружения в клетках
    duration: int = 30  # Длительность эффекта в секундах
    cooldown: int = 60  # Время восстановления
    charges: int = 3  # Количество использований
    
    def activate(self, player_pos: tuple[int, int], level) -> List[tuple[int, int]]:
        """Активация руны - подсвечивает тайные объекты"""
        secret_objects = []
        x, y = player_pos
        
        for dx in range(-self.detection_radius, self.detection_radius + 1):
            for dy in range(-self.detection_radius, self.detection_radius + 1):
                check_x, check_y = x + dx, y + dy
                
                # Проверка на тайные объекты
                if level.is_secret_room(check_x, check_y):
                    secret_objects.append((check_x, check_y))
                elif level.is_secret_passage(check_x, check_y):
                    secret_objects.append((check_x, check_y))
                    
        self.charges -= 1
        return secret_objects
```

#### Визуальный эффект
- Тайные комнаты подсвечиваются **золотым** цветом
- Тайные проходы подсвечиваются **синим** цветом
- Эффект длится 30 секунд
- Пульсирующая анимация

#### Получение
- Находится на **случайных этажах** (5, 10, 15)
- Можно **купить у NPC** за большую сумму
- **Крафт:** 3 руны эффективности + специальный кристалл

---

### 2.3 Руна устойчивости (Стабилизации)

#### Описание
Ключевая руна для прогрессии. Стабилизирует этаж и открывает загадку.

#### Механика стабилизации
```python
@dataclass
class StabilityRune:
    name: str = "Руна устойчивости"
    floor: int  # На каком этаже найдена
    used: bool = False
    
    def stabilize_floor(self, floor_state: FloorState, level) -> dict:
        """Стабилизация этажа"""
        if self.used:
            return {"success": False, "message": "Руна уже использована"}
            
        # Стабилизируем этаж
        floor_state.is_stabilized = True
        floor_state.level_data = level.data.copy()
        
        # Генерируем загадку
        riddle = self._generate_riddle(self.floor)
        
        # Размещаем надпись на стене
        wall_position = self._find_wall_for_riddle(level)
        level.place_riddle(wall_position, riddle)
        
        self.used = True
        
        return {
            "success": True,
            "riddle": riddle,
            "wall_position": wall_position
        }
    
    def _generate_riddle(self, floor: int) -> dict:
        """Генерация загадки для этажа"""
        # Загадка содержит 3 части информации
        return {
            "coordinates_hint": self._get_coordinate_hint(floor),
            "activation_method": self._get_activation_hint(floor),
            "cipher_part": self._get_cipher_part(floor)
        }
```

#### Эффекты стабилизации

**Положительные:**
- ✅ Этаж **не генерируется заново** при входе
- ✅ Можно **запомнить расположение** комнат
- ✅ **Появляется загадка** на стене
- ✅ Можно **строить стратегию** исследования

**Отрицательные:**
- ❌ Предметы **не респавнятся**
- ❌ Враги **не респавнятся**
- ❌ Ловушки **не восстанавливаются**
- ❌ NPC **остаются на месте** (не появляются новые)

#### Визуальные изменения
```python
class StabilizedFloorEffects:
    """Визуальные эффекты стабилизированного этажа"""
    
    @staticmethod
    def apply_visual_changes(level):
        # Стены становятся более "твердыми" (другая текстура)
        level.wall_texture = "stable_wall.png"
        
        # Появляется слабое свечение
        level.ambient_light += 0.1
        
        # Надпись на стене светится
        level.riddle_glow = True
        
        # Частицы стабилизации (один раз при активации)
        spawn_particles("stabilization", duration=3.0)
```

---

## 3. Загадки на стенах

### 3.1 Структура загадки

Каждая загадка содержит **3 части информации**:

```python
@dataclass
class RiddleData:
    # 1. Подсказка о координатах
    coordinate_hint: str
    
    # 2. Способ активации тайника
    activation_method: str
    
    # 3. Часть шифра для замка
    cipher_part: str
    
    # Метаданные
    floor: int
    difficulty: str  # "easy", "medium", "hard"
```

### 3.2 Примеры загадок

#### Этаж 1 (Легкая)
```
Координаты:
"Там, где тени пересекаются дважды,
На расстоянии десяти шагов от входа."

Активация:
"Три свечи зажги по кругу,
И дверь откроется к утру."

Шифр:
"Первая буква - А"
```

#### Этаж 10 (Средняя)
```
Координаты:
"X равен сумме этажей, где нашел ты руны огня,
Y - произведение льда и молнии деля."

Активация:
"Руну карты примени трижды в центре зала,
Чтоб тайна наконец предстала."

Шифр:
"Пятая буква - И, седьмая - В"
```

#### Этаж 20 (Сложная)
```
Координаты:
"Фибоначчи последовательность возьми,
Число этажа умножь на три,
Остаток от деления на ширину карты -
Вот X координата, не забудь азарты."

Активация:
"Пять рун эффективности в пентаграмму сложи,
Кровью своей каждую окропи,
Заклинание древнее прочти -
И путь к сокровищу найди."

Шифр:
"Последние три буквы - Т, О, Р"
```

### 3.3 Система отображения

```python
class RiddleDisplay:
    """Отображение загадки на стене"""
    
    def __init__(self, riddle: RiddleData, position: tuple[int, int]):
        self.riddle = riddle
        self.position = position
        self.discovered = False
        
    def render(self, screen, camera):
        """Отрисовка загадки"""
        if not self.discovered:
            # Показываем только намек
            draw_text(screen, "Древняя надпись...", self.position)
        else:
            # Показываем полный текст
            self._render_full_riddle(screen)
            
    def discover(self):
        """Игрок прочитал загадку"""
        self.discovered = True
        # Добавляем в журнал
        add_to_journal(self.riddle)
```

---

## 4. Главный тайник

### 4.1 Многоступенчатый доступ

Для открытия главного тайника нужно:

1. **Собрать все загадки** (стабилизировать все этажи)
2. **Вычислить координаты** (решить математическую часть)
3. **Узнать способ активации** (собрать подсказки)
4. **Собрать шифр** (из частей на разных этажах)
5. **Вскрыть замок** (ввести код)

```python
class MainVaultAccess:
    """Система доступа к главному тайнику"""
    
    def __init__(self):
        self.riddles_collected = []
        self.coordinates_solved = False
        self.activation_known = False
        self.cipher_complete = False
        
    def check_access(self) -> dict:
        """Проверка возможности доступа"""
        total_riddles = 20  # Всего этажей
        
        progress = {
            "riddles": len(self.riddles_collected),
            "total": total_riddles,
            "coordinates": self.coordinates_solved,
            "activation": self.activation_known,
            "cipher": self.cipher_complete
        }
        
        can_access = (
            len(self.riddles_collected) >= total_riddles and
            self.coordinates_solved and
            self.activation_known and
            self.cipher_complete
        )
        
        return {
            "can_access": can_access,
            "progress": progress,
            "missing": self._get_missing_requirements()
        }
    
    def _get_missing_requirements(self) -> List[str]:
        """Что еще нужно для доступа"""
        missing = []
        
        if len(self.riddles_collected) < 20:
            missing.append(f"Загадок: {len(self.riddles_collected)}/20")
        if not self.coordinates_solved:
            missing.append("Не вычислены координаты")
        if not self.activation_known:
            missing.append("Неизвестен способ активации")
        if not self.cipher_complete:
            missing.append("Неполный шифр")
            
        return missing
```

### 4.2 Процесс открытия

```python
class VaultOpening:
    """Процесс открытия тайника"""
    
    def attempt_open(
        self, 
        coordinates: tuple[int, int],
        activation_items: List[str],
        cipher_code: str
    ) -> dict:
        """Попытка открыть тайник"""
        
        # Проверка координат
        if coordinates != self.secret_coordinates:
            return {
                "success": False,
                "message": "Неверные координаты",
                "hint": self._get_distance_hint(coordinates)
            }
        
        # Проверка активации
        if not self._check_activation(activation_items):
            return {
                "success": False,
                "message": "Неверный способ активации"
            }
        
        # Проверка шифра
        if cipher_code != self.correct_cipher:
            attempts_left = self.max_attempts - self.failed_attempts
            return {
                "success": False,
                "message": f"Неверный код. Осталось попыток: {attempts_left}"
            }
        
        # Успех!
        return {
            "success": True,
            "message": "Тайник открыт!",
            "treasure": self._generate_treasure()
        }
```

---

## 5. Баланс и прогрессия

### 5.1 Распределение рун по этажам

| Этажи | Руны эффективности | Руны карта-ключ | Руны устойчивости |
|-------|-------------------|-----------------|-------------------|
| 1-5   | 2-3 на этаж       | 1 (этаж 5)      | 1 на этаж         |
| 6-10  | 1-2 на этаж       | 1 (этаж 10)     | 1 на этаж         |
| 11-15 | 1 на этаж         | 1 (этаж 15)     | 1 на этаж         |
| 16-20 | 0-1 на этаж       | 1 (этаж 20)     | 1 на этаж         |

### 5.2 Сложность загадок

- **Этажи 1-7:** Простые загадки (прямые подсказки)
- **Этажи 8-14:** Средние (требуют логики)
- **Этажи 15-20:** Сложные (математика, шифры)

### 5.3 Награды за стабилизацию

При стабилизации этажа игрок получает:
- ✅ Загадку (прогресс к финалу)
- ✅ Бонусный опыт
- ✅ Случайный предмет (редкий)
- ✅ Возможность безопасно исследовать этаж

---

## 6. UI для системы рун

### 6.1 Экран экипировки

```
┌─────────────────────────────────────┐
│         ЭКИПИРОВКА РУН              │
├─────────────────────────────────────┤
│                                     │
│  НАРУКАВНИКИ:                       │
│  [Руна Берсерка] [Пусто]            │
│   +30% урон      │                  │
│   -20% защита    │                  │
│                                     │
│  ПОЯС:                              │
│  [Руна Выносливости] [Руна Скорости] [Пусто]│
│   +50 выносливость   +30% скорость  │
│   -10% скорость      -10 HP         │
│                                     │
│  АКТИВНЫЕ ЭФФЕКТЫ:                  │
│  • Урон: 130%                       │
│  • Защита: 80%                      │
│  • Скорость: 120%                   │
│  • Выносливость: +50                │
│  • Здоровье: -10                    │
│                                     │
│  СИНЕРГИИ:                          │
│  ⚡ Марафонец (Выносливость+Скорость)│
│     Бег не тратит выносливость      │
└─────────────────────────────────────┘
```

### 6.2 Журнал загадок

```
┌─────────────────────────────────────┐
│         ЖУРНАЛ ЗАГАДОК              │
├─────────────────────────────────────┤
│ Этаж 1: ✓ Решена                    │
│ Этаж 2: ✓ Решена                    │
│ Этаж 3: ⏳ В процессе               │
│ Этаж 4-20: 🔒 Не найдены            │
│                                     │
│ ПРОГРЕСС К ТАЙНИКУ:                 │
│ ▓▓▓░░░░░░░ 30%                      │
│                                     │
│ • Загадок собрано: 3/20             │
│ • Координаты: Не вычислены          │
│ • Активация: Частично известна      │
│ • Шифр: А__И___                     │
└─────────────────────────────────────┘
```

---

Это детальная спецификация системы рун! Готов обсудить любые аспекты или добавить детали! 🎮
