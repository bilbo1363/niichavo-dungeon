# Технический стек и инструменты разработки (Python)

## 1. Рекомендуемый технологический стек

### 1.1 Основа игры

#### **Язык программирования**
```
Python 3.11+
├── Быстрая разработка
├── Читаемый код
├── Type hints для типизации
├── Богатая экосистема библиотек
└── Отличная поддержка NumPy для производительности
```

**Преимущества для проекта:**
- Быстрое прототипирование механик
- NumPy для эффективной генерации уровней
- Простое управление состоянием игры
- Desktop-first подход (Steam, itch.io)

#### **Игровой движок**

**Вариант 1: Pygame 2.5+ (рекомендуется)**
```python
Преимущества:
+ Проверенный временем (20+ лет)
+ Огромное сообщество
+ Множество туториалов
+ Простой API
+ Кросс-платформенность
+ Отличная документация

Недостатки:
- Нет встроенной физики (но есть pymunk)
- Базовый рендеринг (но достаточно для 2D)
```

**Вариант 2: Arcade 2.6+**
```python
Преимущества:
+ Современный API
+ Встроенная физика (Pymunk)
+ Лучшая производительность
+ Поддержка шейдеров
+ Sprite lists для оптимизации

Недостатки:
- Меньшее сообщество
- Меньше туториалов
```

**Вариант 3: Pyglet**
```python
Преимущества:
+ OpenGL рендеринг
+ Легковесный
+ Без зависимостей

Недостатки:
- Более низкоуровневый
- Меньше готовых решений
```

**Рекомендация:** Pygame 2.5+ для стабильности и сообщества

### 1.2 Дополнительные библиотеки

#### **Математика и генерация**
```python
# NumPy - быстрые массивы и вычисления
import numpy as np

# Генерация уровня с NumPy (в 10-100 раз быстрее списков)
level = np.zeros((height, width), dtype=np.uint8)

# Noise - процедурная генерация (Perlin, Simplex)
from noise import pnoise2
noise_val = pnoise2(x/10, y/10, base=seed)
```

#### **Управление данными**
```python
# Pydantic - валидация данных с type hints
from pydantic import BaseModel, Field

class PlayerData(BaseModel):
    health: int = Field(ge=0, le=100)
    position: tuple[int, int]
    inventory: list[str] = []

# PyYAML - конфигурация и данные
import yaml
with open('config.yaml') as f:
    config = yaml.safe_load(f)
```

#### **Упаковка для Desktop**
```python
# PyInstaller - создание exe/app
pyinstaller --onefile --windowed main.py

# cx_Freeze - альтернатива
# Nuitka - компиляция в C++ (максимальная производительность)
```

### 1.3 Управление состоянием

#### **State Management**
```typescript
// Простой State Manager
class StateManager {
  private state: GameState;
  private listeners: Map<string, Function[]>;
  
  setState(newState: Partial<GameState>): void {
    this.state = { ...this.state, ...newState };
    this.notify();
  }
  
  subscribe(key: string, callback: Function): void {
    // ...
  }
}
```

**Альтернативы:**
- Redux (избыточно для игр)
- MobX (реактивность)
- Zustand (легковесный)

### 1.4 Работа с данными

#### **Формат данных**
```
JSON - для конфигурации, сохранений
YAML - для уровней, квестов (более читаемо)
Binary - для больших данных (карты)
```

#### **Валидация**
```typescript
// Zod для валидации схем
import { z } from 'zod';

const PlayerSchema = z.object({
  health: z.number().min(0).max(100),
  position: z.object({
    x: z.number(),
    y: z.number(),
  }),
});
```

---

## 2. Backend (опционально)

### 2.1 Серверная часть

#### **Node.js + Express**
```typescript
// server.ts
import express from 'express';
import { createServer } from 'http';
import { Server } from 'socket.io';

const app = express();
const httpServer = createServer(app);
const io = new Server(httpServer);

// REST API для сохранений
app.post('/api/save', async (req, res) => {
  // Сохранение в БД
});

// WebSocket для мультиплеера
io.on('connection', (socket) => {
  socket.on('player-move', (data) => {
    socket.broadcast.emit('player-moved', data);
  });
});
```

### 2.2 База данных

#### **Для сохранений: PostgreSQL**
```sql
CREATE TABLE saves (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  save_data JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_saves_user_id ON saves(user_id);
```

#### **Для лидербордов: Redis**
```typescript
// Быстрые операции с рейтингом
await redis.zadd('leaderboard', score, userId);
const top10 = await redis.zrevrange('leaderboard', 0, 9, 'WITHSCORES');
```

### 2.3 Аутентификация

#### **Passport.js + JWT**
```typescript
import passport from 'passport';
import { Strategy as JwtStrategy } from 'passport-jwt';

passport.use(new JwtStrategy(options, (payload, done) => {
  User.findById(payload.sub)
    .then(user => done(null, user))
    .catch(err => done(err));
}));
```

---

## 3. Инструменты разработки

### 3.1 IDE и редакторы

#### **Visual Studio Code (рекомендуется)**
```json
// .vscode/settings.json
{
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.tsdk": "node_modules/typescript/lib"
}
```

**Расширения:**
- ESLint
- Prettier
- GitLens
- Error Lens
- TypeScript Hero
- Phaser 3 Snippets

**Альтернативы:**
- WebStorm (платный, но мощный)
- Sublime Text (легковесный)

### 3.2 Контроль версий

#### **Git + GitHub**
```bash
# .gitignore
node_modules/
dist/
.env
*.log
.DS_Store
```

**Git Flow:**
```
main - стабильная версия
develop - разработка
feature/* - новые фичи
hotfix/* - срочные исправления
release/* - подготовка релиза
```

**Commit conventions:**
```
feat: добавлена система крафта
fix: исправлен баг с генерацией уровней
docs: обновлена документация
refactor: рефакторинг класса Player
test: добавлены тесты для боевой системы
```

### 3.3 Качество кода

#### **ESLint**
```javascript
// .eslintrc.js
module.exports = {
  parser: '@typescript-eslint/parser',
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
    'prettier',
  ],
  rules: {
    'no-console': 'warn',
    '@typescript-eslint/no-unused-vars': 'error',
    '@typescript-eslint/explicit-function-return-type': 'warn',
  },
};
```

#### **Prettier**
```json
// .prettierrc
{
  "semi": true,
  "trailingComma": "all",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2
}
```

#### **Husky (pre-commit hooks)**
```json
// package.json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "pre-push": "npm test"
    }
  },
  "lint-staged": {
    "*.ts": ["eslint --fix", "prettier --write"]
  }
}
```

---

## 4. Тестирование

### 4.1 Юнит-тесты: Jest

```typescript
// player.test.ts
import { Player } from './Player';

describe('Player', () => {
  let player: Player;

  beforeEach(() => {
    player = new Player({ x: 0, y: 0 });
  });

  test('should move correctly', () => {
    player.move(1, 0);
    expect(player.x).toBe(1);
    expect(player.y).toBe(0);
  });

  test('should take damage', () => {
    const initialHealth = player.health;
    player.takeDamage(10);
    expect(player.health).toBe(initialHealth - 10);
  });
});
```

**Конфигурация:**
```javascript
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  collectCoverageFrom: ['src/**/*.ts'],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70,
    },
  },
};
```

### 4.2 E2E тесты: Playwright

```typescript
// e2e/game.spec.ts
import { test, expect } from '@playwright/test';

test('should start new game', async ({ page }) => {
  await page.goto('http://localhost:8000');
  await page.click('text=Новая игра');
  
  // Проверяем, что игра началась
  await expect(page.locator('#gameCanvas')).toBeVisible();
});

test('player can move', async ({ page }) => {
  await page.goto('http://localhost:8000');
  await page.click('text=Новая игра');
  
  // Нажимаем стрелку вправо
  await page.keyboard.press('ArrowRight');
  
  // Проверяем, что позиция изменилась
  const position = await page.evaluate(() => window.game.player.x);
  expect(position).toBeGreaterThan(0);
});
```

### 4.3 Визуальное тестирование

```typescript
// Snapshot тесты для UI
test('main menu should match snapshot', async ({ page }) => {
  await page.goto('http://localhost:8000');
  expect(await page.screenshot()).toMatchSnapshot('main-menu.png');
});
```

---

## 5. Графика и ассеты

### 5.1 Создание графики

#### **Пиксель-арт**
```
Aseprite ($19.99) - лучший инструмент для пиксель-арта
├── Анимации
├── Тайлсеты
├── Спрайт-листы
└── Экспорт в различные форматы

Альтернативы:
- Piskel (бесплатно, онлайн)
- GraphicsGale (бесплатно)
- GIMP (бесплатно, сложнее)
```

#### **Векторная графика (для UI)**
```
Figma (бесплатно для личного использования)
├── UI дизайн
├── Иконки
├── Прототипирование
└── Коллаборация

Альтернативы:
- Adobe Illustrator (платно)
- Inkscape (бесплатно)
```

### 5.2 Оптимизация ассетов

#### **Изображения**
```bash
# Оптимизация PNG
pngquant --quality=65-80 input.png -o output.png

# Конвертация в WebP
cwebp -q 80 input.png -o output.webp

# Создание спрайт-атласа
TexturePacker sprites/*.png --sheet atlas.png --data atlas.json
```

#### **Аудио**
```bash
# Конвертация в OGG (лучше сжатие)
ffmpeg -i input.wav -c:a libvorbis -q:a 4 output.ogg

# Конвертация в MP3
ffmpeg -i input.wav -b:a 128k output.mp3
```

### 5.3 Управление ассетами

```typescript
// AssetManager.ts
class AssetManager {
  private assets: Map<string, any> = new Map();
  
  async loadImage(key: string, path: string): Promise<void> {
    const img = new Image();
    img.src = path;
    await img.decode();
    this.assets.set(key, img);
  }
  
  async loadAudio(key: string, path: string): Promise<void> {
    const audio = new Audio(path);
    await audio.load();
    this.assets.set(key, audio);
  }
  
  get(key: string): any {
    return this.assets.get(key);
  }
}
```

---

## 6. Звук и музыка

### 6.1 Создание звуков

#### **Инструменты**
```
LMMS (бесплатно) - создание музыки
├── Синтезаторы
├── Сэмплы
├── Эффекты
└── Экспорт в WAV/OGG

Audacity (бесплатно) - редактирование звука
├── Запись
├── Обработка
├── Эффекты
└── Экспорт

Bfxr (бесплатно) - генератор звуковых эффектов
└── Идеально для ретро-звуков
```

### 6.2 Библиотеки звуков

**Бесплатные:**
- Freesound.org
- OpenGameArt.org
- Zapsplat.com (бесплатный план)

**Платные:**
- AudioJungle (от $1)
- Epidemic Sound (подписка)
- Artlist (подписка)

### 6.3 Аудио движок

```typescript
// Howler.js - лучшая библиотека для веб-аудио
import { Howl } from 'howler';

class AudioManager {
  private sounds: Map<string, Howl> = new Map();
  
  load(key: string, src: string): void {
    this.sounds.set(key, new Howl({
      src: [src],
      volume: 0.5,
    }));
  }
  
  play(key: string): void {
    this.sounds.get(key)?.play();
  }
  
  setVolume(key: string, volume: number): void {
    this.sounds.get(key)?.volume(volume);
  }
}
```

---

## 7. CI/CD и деплой

### 7.1 GitHub Actions

```yaml
# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run lint
      - run: npm test
      - run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm ci
      - run: npm run build
      - uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
```

### 7.2 Платформы деплоя

#### **GitHub Pages (бесплатно)**
```bash
# Автоматический деплой через Actions
# Доступно по адресу: username.github.io/repository
```

#### **Netlify (бесплатно)**
```toml
# netlify.toml
[build]
  command = "npm run build"
  publish = "dist"

[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200
```

#### **Vercel (бесплатно)**
```json
// vercel.json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "rewrites": [
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

---

## 8. Мониторинг и аналитика

### 8.1 Аналитика игроков

#### **Google Analytics 4**
```typescript
// analytics.ts
import ReactGA from 'react-ga4';

ReactGA.initialize('G-XXXXXXXXXX');

export const trackEvent = (category: string, action: string, label?: string) => {
  ReactGA.event({
    category,
    action,
    label,
  });
};

// Использование
trackEvent('Game', 'Level Complete', 'Level 1');
trackEvent('Combat', 'Enemy Killed', 'Mutant');
```

#### **Собственная аналитика**
```typescript
class Analytics {
  private events: Event[] = [];
  
  track(event: string, data: any): void {
    this.events.push({
      event,
      data,
      timestamp: Date.now(),
    });
    
    // Отправка на сервер каждые 100 событий
    if (this.events.length >= 100) {
      this.flush();
    }
  }
  
  async flush(): Promise<void> {
    await fetch('/api/analytics', {
      method: 'POST',
      body: JSON.stringify(this.events),
    });
    this.events = [];
  }
}
```

### 8.2 Мониторинг ошибок

#### **Sentry**
```typescript
import * as Sentry from '@sentry/browser';

Sentry.init({
  dsn: 'YOUR_DSN',
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// Автоматический отлов ошибок
try {
  // код
} catch (error) {
  Sentry.captureException(error);
}
```

### 8.3 Производительность

#### **Performance API**
```typescript
class PerformanceMonitor {
  private metrics: Map<string, number[]> = new Map();
  
  measure(name: string, fn: () => void): void {
    const start = performance.now();
    fn();
    const duration = performance.now() - start;
    
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }
    this.metrics.get(name)!.push(duration);
  }
  
  getAverage(name: string): number {
    const values = this.metrics.get(name) || [];
    return values.reduce((a, b) => a + b, 0) / values.length;
  }
}
```

---

## 9. Документация

### 9.1 Код документация

#### **TSDoc**
```typescript
/**
 * Класс игрока
 * @class Player
 * @extends Entity
 */
class Player extends Entity {
  /**
   * Перемещает игрока на указанное расстояние
   * @param dx - Смещение по X
   * @param dy - Смещение по Y
   * @returns true если перемещение успешно
   */
  move(dx: number, dy: number): boolean {
    // ...
  }
}
```

#### **TypeDoc (генератор документации)**
```bash
# Установка
npm install --save-dev typedoc

# Генерация
npx typedoc --out docs src
```

### 9.2 API документация

#### **Swagger/OpenAPI (для backend)**
```typescript
/**
 * @swagger
 * /api/save:
 *   post:
 *     summary: Сохранить игру
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/SaveData'
 */
app.post('/api/save', async (req, res) => {
  // ...
});
```

---

## 10. Package.json (полная версия)

```json
{
  "name": "dungeon-niichavo",
  "version": "1.0.0",
  "description": "Roguelike game inspired by Strugatsky brothers",
  "main": "src/main.ts",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:e2e": "playwright test",
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix",
    "format": "prettier --write \"src/**/*.ts\"",
    "type-check": "tsc --noEmit",
    "docs": "typedoc --out docs src"
  },
  "dependencies": {
    "phaser": "^3.60.0",
    "howler": "^2.2.3",
    "zod": "^3.22.0"
  },
  "devDependencies": {
    "@types/jest": "^29.5.0",
    "@types/node": "^20.0.0",
    "@typescript-eslint/eslint-plugin": "^6.0.0",
    "@typescript-eslint/parser": "^6.0.0",
    "@playwright/test": "^1.40.0",
    "eslint": "^8.50.0",
    "eslint-config-prettier": "^9.0.0",
    "eslint-plugin-prettier": "^5.0.0",
    "husky": "^8.0.0",
    "jest": "^29.7.0",
    "lint-staged": "^15.0.0",
    "prettier": "^3.0.0",
    "ts-jest": "^29.1.0",
    "typedoc": "^0.25.0",
    "typescript": "^5.2.0",
    "vite": "^5.0.0"
  },
  "engines": {
    "node": ">=18.0.0",
    "npm": ">=9.0.0"
  }
}
```

---

## 11. Рекомендации по выбору стека

### Для быстрого прототипа:
- JavaScript + Phaser 3
- Vite для сборки
- Минимум зависимостей

### Для серьёзной разработки:
- TypeScript + Phaser 3
- Vite + Jest + Playwright
- ESLint + Prettier + Husky
- GitHub Actions для CI/CD

### Для максимальной производительности:
- TypeScript + Custom Engine (WebGL)
- Rust + WebAssembly для критичных частей
- Web Workers для тяжелых вычислений
- Продвинутая оптимизация

**Вывод:** Начните с TypeScript + Phaser 3, это оптимальный баланс между скоростью разработки и качеством кода.
